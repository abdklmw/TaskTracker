@using TaskTracker.Models
@using TaskTracker.Models.Invoice
@model InvoiceIndexViewModel
@{
    ViewData["Title"] = "Invoices";
    var createModel = ViewBag.CreateModel as InvoiceCreateViewModel ?? new InvoiceCreateViewModel();
    var hasFilters = Model.SelectedClientID != 0 || Model.SelectedStatus.HasValue || Model.PaidDateStart.HasValue ||
                     Model.PaidDateEnd.HasValue || Model.InvoiceDateStart.HasValue || Model.InvoiceDateEnd.HasValue ||
                     Model.InvoiceSentDateStart.HasValue || Model.InvoiceSentDateEnd.HasValue ||
                     Model.TotalAmountMin.HasValue || Model.TotalAmountMax.HasValue;
    var showFilterForm = hasFilters;
}
<!-- Display success or error messages -->
@await Html.PartialAsync("~/Views/Shared/_AlertsPartial.cshtml")

<!-- Create form partial, hidden by default -->
@await Html.PartialAsync("_CreateForm", createModel)

<!-- Header with Create New button -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Invoices</h1>
    <div>
        <button id="create-new-btn" class="btn btn-primary ml-2">Create New</button>
    </div>
</div>

<!-- Filter Form -->
<div id="filter-form" class="row mb-3" style="display: @(showFilterForm ? "block" : "none");">
    <div class="col-12">
        <form asp-action="Index" method="get">
            <div class="filter-form-container row g-3">
                <div class="filter-group col-md-3">
                    <label asp-for="SelectedClientID" class="form-label">Filter by Client</label>
                    <select asp-for="SelectedClientID" class="form-select" asp-items="Model.ClientFilterOptions">
                        <option value="0">All Clients</option>
                    </select>
                </div>
                <div class="filter-group col-md-3">
                    <label asp-for="SelectedStatus" class="form-label">Status</label>
                    <select asp-for="SelectedStatus" class="form-select" asp-items="Model.StatusFilterOptions"></select>
                </div>
                <div class="filter-group col-md-3">
                    <label asp-for="InvoiceDateStart" class="form-label">Invoice Date From</label>
                    <input asp-for="InvoiceDateStart" class="form-control" type="date" />
                </div>
                <div class="filter-group col-md-3">
                    <label asp-for="InvoiceDateEnd" class="form-label">Invoice Date To</label>
                    <input asp-for="InvoiceDateEnd" class="form-control" type="date" />
                </div>
                <div class="filter-group col-md-3">
                    <label asp-for="InvoiceSentDateStart" class="form-label">Sent Date From</label>
                    <input asp-for="InvoiceSentDateStart" class="form-control" type="date" />
                </div>
                <div class="filter-group col-md-3">
                    <label asp-for="InvoiceSentDateEnd" class="form-label">Sent Date To</label>
                    <input asp-for="InvoiceSentDateEnd" class="form-control" type="date" />
                </div>
                <div class="filter-group col-md-3">
                    <label asp-for="PaidDateStart" class="form-label">Paid Date From</label>
                    <input asp-for="PaidDateStart" class="form-control" type="date" />
                </div>
                <div class="filter-group col-md-3">
                    <label asp-for="PaidDateEnd" class="form-label">Paid Date To</label>
                    <input asp-for="PaidDateEnd" class="form-control" type="date" />
                </div>
                <div class="filter-group col-md-3">
                    <label asp-for="TotalAmountMin" class="form-label">Min Amount</label>
                    <input asp-for="TotalAmountMin" class="form-control" type="number" step="0.01" />
                </div>
                <div class="filter-group col-md-3">
                    <label asp-for="TotalAmountMax" class="form-label">Max Amount</label>
                    <input asp-for="TotalAmountMax" class="form-control" type="number" step="0.01" />
                </div>
            </div>
            <div class="filter-actions mt-3">
                <button type="submit" class="btn btn-primary">Apply Filter</button>
                @if (hasFilters)
                {
                    <button type="button" id="clear-filter-btn" class="clear-filter-btn">
                        <img src="~/images/icons/filter-xmark.svg" alt="Clear Filter" class="filter-icon" />
                    </button>
                }
            </div>
            <input type="hidden" name="page" value="1" />
            <input type="hidden" name="recordLimit" value="@Model.RecordLimit" />
        </form>
    </div>
</div>

<!-- Results and Controls -->
<div class="results-container mb-3">
    <div>
        @if (Model.TotalRecords > 0)
        {
            <p>Showing @Model.Invoices.Count() of @Model.TotalRecords records</p>
        }
        else
        {
            <p>No invoices match the selected filter.</p>
        }
    </div>
    <div class="controls-container">
        <button id="show-filter-btn" class="filter-btn" style="display: @(showFilterForm ? "none" : "inline-block");">
            <img src="~/images/icons/filter.svg" alt="Show Filter" class="filter-icon" />
        </button>
        <form asp-action="Index" method="get" class="records-per-page-form">
            <label for="recordLimit" class="form-label">Records per page</label>
            <select id="recordLimit" name="recordLimit" class="form-select" asp-items="Model.RecordLimitOptions" onchange="this.form.submit()"></select>
            <input type="hidden" name="page" value="1" />
            <input type="hidden" name="clientFilter" value="@Model.SelectedClientID" />
            <input type="hidden" name="statusFilter" value="@Model.SelectedStatus" />
            <input type="hidden" name="paidDateStart" value="@(Model.PaidDateStart?.ToString("yyyy-MM-dd"))" />
            <input type="hidden" name="paidDateEnd" value="@(Model.PaidDateEnd?.ToString("yyyy-MM-dd"))" />
            <input type="hidden" name="invoiceDateStart" value="@(Model.InvoiceDateStart?.ToString("yyyy-MM-dd"))" />
            <input type="hidden" name="invoiceDateEnd" value="@(Model.InvoiceDateEnd?.ToString("yyyy-MM-dd"))" />
            <input type="hidden" name="invoiceSentDateStart" value="@(Model.InvoiceSentDateStart?.ToString("yyyy-MM-dd"))" />
            <input type="hidden" name="invoiceSentDateEnd" value="@(Model.InvoiceSentDateEnd?.ToString("yyyy-MM-dd"))" />
            <input type="hidden" name="totalAmountMin" value="@Model.TotalAmountMin" />
            <input type="hidden" name="totalAmountMax" value="@Model.TotalAmountMax" />
        </form>
    </div>
</div>

<!-- Pagination -->
@await Html.PartialAsync("_PaginationPartial", Model)

<!-- Header row for the invoice list -->
@if (Model.TotalRecords > 0)
{
    <div class="row mb-2">
        <div class="col-md-3"><strong>@Html.DisplayNameFor(model => model.Invoices.First().InvoiceDate)</strong></div>
        <div class="col-md-3"><strong>@Html.DisplayNameFor(model => model.Invoices.First().TotalAmount)</strong></div>
        <div class="col-md-3"><strong>@Html.DisplayNameFor(model => model.Invoices.First().Status)</strong></div>
        <div class="col-md-3"><strong>@Html.DisplayNameFor(model => model.Invoices.First().Client)</strong></div>
    </div>
    @foreach (var item in Model.Invoices)
    {
        @await Html.PartialAsync("_DisplayRow", item)
        @await Html.PartialAsync("_EditFormRow", item)
    }
}

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
}